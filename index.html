<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Rights Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
    <div id="app" class="min-h-screen flex items-center justify-center p-6"></div>

    <script>
        // In-memory state
        const state = {
            step: 'upload',
            artist: {
                name: '',
                email: '',
                ownsMasters: null,
                isComposer: null,
                releaseYears: '',
                hasPastReleases: false,
                tracks: []
            },
            conflicts: null,
            uploadedText: ''
        };

        function render() {
            const app = document.getElementById('app');
            
            if (state.step === 'upload') {
                app.innerHTML = renderUpload();
            } else if (state.step === 'processing') {
                app.innerHTML = renderProcessing();
            } else if (state.step === 'review') {
                app.innerHTML = renderReview();
            } else if (state.step === 'dashboard') {
                app.innerHTML = renderDashboard();
            }
        }

        function renderUpload() {
            return `
                <div class="max-w-2xl w-full">
                    <div class="text-center mb-8">
                        <svg class="w-16 h-16 mx-auto mb-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                        <h1 class="text-4xl font-bold mb-2 text-gray-900">Music Rights Agent</h1>
                        <p class="text-xl text-gray-600">Upload your tracklist and I'll handle the rest</p>
                    </div>

                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <div 
                            id="dropzone"
                            class="border-3 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-blue-500 hover:bg-blue-50 transition cursor-pointer"
                            ondrop="handleDrop(event)"
                            ondragover="handleDragOver(event)"
                            ondragleave="handleDragLeave(event)"
                            onclick="document.getElementById('fileInput').click()"
                        >
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-lg font-medium text-gray-700 mb-2">Drop your tracklist or credits file here</p>
                            <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                            <p class="text-xs text-gray-400">Supports .txt, images (jpg, png)</p>
                            <input type="file" id="fileInput" class="hidden" accept=".txt,.jpg,.jpeg,.png,.heic" onchange="handleFile(event)">
                        </div>

                        <div class="relative my-6">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-4 bg-white text-gray-500">or paste your credits</span>
                            </div>
                        </div>

                        <textarea 
                            id="pasteArea"
                            class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-blue-600 focus:outline-none resize-none"
                            rows="6"
                            placeholder="Paste your tracklist, credits, or metadata here...

Example:
Track 1: Song Title
Written by: Your Name
Produced by: Your Name
Release: 2024"
                            onpaste="setTimeout(() => handlePaste(), 100)"
                        ></textarea>

                        <button 
                            onclick="processManualInput()"
                            class="w-full mt-4 bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 transition shadow-lg"
                        >
                            Get My Action Plan
                        </button>
                    </div>

                    <div class="mt-6 text-center text-sm text-gray-500">
                        <p>‚úì Free assessment ‚Ä¢ ‚úì Takes 2 minutes ‚Ä¢ ‚úì EU-focused</p>
                    </div>
                </div>
            `;
        }

        function renderProcessing() {
            return `
                <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-12 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-6"></div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Analyzing your credits...</h2>
                    <p class="text-gray-600">Extracting ownership info, roles, and metadata</p>
                </div>
            `;
        }

        function renderReview() {
            const ownsMastersYes = state.artist.ownsMasters === true;
            const ownsMastersNo = state.artist.ownsMasters === false;
            const isComposerYes = state.artist.isComposer === true;
            const isComposerNo = state.artist.isComposer === false;

            return `
                <div class="max-w-3xl w-full bg-white rounded-2xl shadow-xl p-8">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Review Extracted Info</h2>
                        <p class="text-gray-600">I've analyzed your credits. Please verify and complete:</p>
                    </div>

                    <div class="space-y-6">
                        ${state.conflicts && (state.conflicts.clarifications.length > 0 || state.conflicts.errors.length > 0 || state.conflicts.masterNotes || state.conflicts.compositionNotes) ? `
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                                <div class="font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Extraction Notes</div>
                                ${state.conflicts.masterNotes ? `<div class="text-sm text-yellow-800 mb-2"><strong>Master ownership:</strong> ${state.conflicts.masterNotes}</div>` : ''}
                                ${state.conflicts.compositionNotes ? `<div class="text-sm text-yellow-800 mb-2"><strong>Composition:</strong> ${state.conflicts.compositionNotes}</div>` : ''}
                                ${state.conflicts.clarifications.length > 0 ? `
                                    <div class="text-sm text-yellow-800 mt-3">
                                        <strong>Please clarify:</strong>
                                        <ul class="list-disc ml-5 mt-1">
                                            ${state.conflicts.clarifications.map(q => `<li>${q}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${state.conflicts.errors.length > 0 ? `
                                    <div class="text-sm text-yellow-800 mt-3">
                                        <strong>Parsing issues:</strong>
                                        <ul class="list-disc ml-5 mt-1">
                                            ${state.conflicts.errors.map(e => `<li>${e}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Artist Name</label>
                            <input 
                                type="text" 
                                id="artistName"
                                value="${state.artist.name}"
                                oninput="state.artist.name = this.value"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                placeholder="Your artist name"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input 
                                type="email" 
                                id="artistEmail"
                                value="${state.artist.email}"
                                oninput="state.artist.email = this.value"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                placeholder="your@email.com"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Do you own the master recordings?</label>
                            <div class="flex gap-3">
                                <button 
                                    onclick="updateField('ownsMasters', true)"
                                    class="flex-1 py-3 px-4 border-2 rounded-lg font-medium transition ${ownsMastersYes ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-300 hover:border-gray-400'}"
                                >
                                    ‚úì Yes, I own them
                                </button>
                                <button 
                                    onclick="updateField('ownsMasters', false)"
                                    class="flex-1 py-3 px-4 border-2 rounded-lg font-medium transition ${ownsMastersNo ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-300 hover:border-gray-400'}"
                                >
                                    ‚úó No, label owns
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Did you write the music and lyrics?</label>
                            <div class="flex gap-3">
                                <button 
                                    onclick="updateField('isComposer', true)"
                                    class="flex-1 py-3 px-4 border-2 rounded-lg font-medium transition ${isComposerYes ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-300 hover:border-gray-400'}"
                                >
                                    ‚úì Yes, I wrote it
                                </button>
                                <button 
                                    onclick="updateField('isComposer', false)"
                                    class="flex-1 py-3 px-4 border-2 rounded-lg font-medium transition ${isComposerNo ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-300 hover:border-gray-400'}"
                                >
                                    ‚úó No, co-written
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Release Year(s)</label>
                            <input 
                                type="text" 
                                id="releaseYears"
                                value="${state.artist.releaseYears}"
                                oninput="state.artist.releaseYears = this.value"
                                class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                placeholder="e.g. 2024 or 2023-2024"
                            >
                        </div>

                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    id="hasPastReleases"
                                    ${state.artist.hasPastReleases ? 'checked' : ''}
                                    onchange="state.artist.hasPastReleases = this.checked; render();"
                                    class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                >
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">I have past releases I want to claim royalties for</div>
                                    <div class="text-sm text-gray-600 mt-1">You may be able to claim retroactive royalties for releases from previous years (typically up to 3-5 years back)</div>
                                </div>
                            </label>
                        </div>

                        ${state.artist.tracks.length > 0 ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="font-medium text-gray-900 mb-2">Detected Tracks:</div>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    ${state.artist.tracks.slice(0, 5).map(t => `<li>‚Ä¢ ${t}</li>`).join('')}
                                    ${state.artist.tracks.length > 5 ? `<li class="text-gray-500">...and ${state.artist.tracks.length - 5} more</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}

                        <button 
                            onclick="finalize()"
                            class="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-blue-700 transition shadow-lg mt-8"
                        >
                            Continue to Dashboard ‚Üí
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            return `
                <div class="max-w-4xl w-full">
                    <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-900 mb-1">Welcome, ${state.artist.name}</h2>
                                <p class="text-gray-600">${state.artist.email}</p>
                            </div>
                            <button onclick="state.step = 'review'; render();" class="text-blue-600 hover:underline font-medium text-sm">
                                Edit Info
                            </button>
                        </div>

                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-8">
                            <div class="flex items-start gap-4">
                                <svg class="w-8 h-8 text-blue-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <div class="font-bold text-blue-900 text-lg mb-1">Registration Status</div>
                                    <div class="text-blue-800">
                                        Independent artists often miss royalties from streaming, radio, and public performances because they haven't registered with collection societies. Let's get you set up.${state.artist.hasPastReleases ? ' <strong>Note:</strong> You may be able to claim retroactive royalties for your past releases.' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Your Action Plan</h3>
                        <p class="text-gray-600 mb-6">Complete these tasks in order. Each takes 5-10 minutes.</p>
                        
                        <div class="space-y-4 mb-8">
                            <!-- Task 1: SABAM -->
                            <div class="border-2 border-blue-300 bg-blue-50 rounded-xl p-5">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">
                                        1
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-900 text-lg">Register with SABAM (Writer & Publisher)</h4>
                                                <p class="text-sm text-gray-600 mt-1">Collects composition royalties from streaming, radio, and public performance</p>
                                                <span class="inline-block mt-2 text-xs font-semibold text-blue-700 bg-blue-200 px-2 py-1 rounded">‚è± 5 minutes</span>
                                            </div>
                                        </div>
                                        <div class="mt-3 flex gap-2">
                                            <button 
                                                onclick="copySabamEmail()"
                                                class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition"
                                            >
                                                üìß Copy Registration Email
                                            </button>
                                            <button 
                                                onclick="window.open('https://www.sabam.be/en/membership', '_blank')"
                                                class="px-4 py-3 border-2 border-blue-600 text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition"
                                            >
                                                üîó Open Registration Page
                                            </button>
                                        </div>
                                        <div class="mt-3 text-sm text-gray-600 bg-white p-3 rounded border">
                                            <strong>What to do:</strong> Copy the email, send it to info@sabam.be, then wait 1-2 days for their registration forms.${state.artist.hasPastReleases ? ' <strong>Mention your past releases</strong> to inquire about retroactive royalties.' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Task 2: PlayRight -->
                            <div class="border-2 border-gray-300 rounded-xl p-5">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-bold">
                                        2
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-900 text-lg">Register with PlayRight (Performer)</h4>
                                                <p class="text-sm text-gray-600 mt-1">Collects performer royalties from radio, TV, and public venues</p>
                                                <span class="inline-block mt-2 text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded">‚è± 5 minutes</span>
                                            </div>
                                        </div>
                                        <div class="mt-3 flex gap-2">
                                            <button 
                                                onclick="copyPlayRightEmail()"
                                                class="flex-1 bg-gray-700 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-800 transition"
                                            >
                                                üìß Copy Registration Email
                                            </button>
                                            <button 
                                                onclick="window.open('https://playright.be/en/how-to-join-playright-as-a-member/', '_blank')"
                                                class="px-4 py-3 border-2 border-gray-700 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition"
                                            >
                                                üîó Open Registration Page
                                            </button>
                                        </div>
                                        <div class="mt-3 text-sm text-gray-600 bg-gray-50 p-3 rounded border">
                                            <strong>What to do:</strong> Copy the email, send it to info@playright.be, or register directly on their website.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Task 3: ISRC -->
                            <div class="border-2 border-gray-300 rounded-xl p-5">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-bold">
                                        3
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-900 text-lg">Get ISRC Codes for Your Tracks</h4>
                                                <p class="text-sm text-gray-600 mt-1">Unique identifiers needed before uploading to Spotify, Apple Music, etc.</p>
                                                <span class="inline-block mt-2 text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded">‚è± 10 minutes</span>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button 
                                                onclick="window.open('https://www.usisrc.org/about/index.html', '_blank')"
                                                class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-800 transition"
                                            >
                                                üìñ ISRC Official Guide
                                            </button>
                                        </div>
                                        <div class="mt-3 text-sm text-gray-600 bg-gray-50 p-3 rounded border">
                                            <strong>Easy option:</strong> Most distributors (DistroKid, TuneCore, CD Baby) generate ISRCs automatically when you upload. If you're using a distributor, you can skip this step.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Task 4: Metadata -->
                            <div class="border-2 border-gray-300 rounded-xl p-5">
                                <div class="flex items-start gap-4">
                                    <div class="flex-shrink-0 w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center font-bold">
                                        4
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h4 class="font-bold text-gray-900 text-lg">Document Your Metadata</h4>
                                                <p class="text-sm text-gray-600 mt-1">Keep a master record of all your release info</p>
                                                <span class="inline-block mt-2 text-xs font-semibold text-gray-700 bg-gray-200 px-2 py-1 rounded">‚è± 5 minutes</span>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3 bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                            <div class="font-medium text-gray-900 mb-3">üìã Your Extracted Metadata:</div>
                                            
                                            <div class="space-y-2 text-sm">
                                                <div><strong>Artist:</strong> ${state.artist.name}</div>
                                                <div><strong>Email:</strong> ${state.artist.email}</div>
                                                ${state.artist.releaseYears ? `<div><strong>Release Year:</strong> ${state.artist.releaseYears}</div>` : ''}
                                                
                                                <div class="pt-2 border-t border-gray-300 mt-2">
                                                    <strong>Ownership:</strong>
                                                    <div class="ml-4 mt-1">
                                                        ${state.artist.ownsMasters === true ? '‚úì Masters: You own them' : state.artist.ownsMasters === false ? '‚úó Masters: Label owns' : ''}
                                                    </div>
                                                    <div class="ml-4">
                                                        ${state.artist.isComposer === true ? '‚úì Composition: You wrote it' : state.artist.isComposer === false ? '‚úó Composition: Co-written' : ''}
                                                    </div>
                                                </div>
                                                
                                                ${state.artist.tracks.length > 0 ? `
                                                    <div class="pt-2 border-t border-gray-300 mt-2">
                                                        <strong>Tracks (${state.artist.tracks.length}):</strong>
                                                        <ul class="ml-4 mt-1 space-y-1">
                                                            ${state.artist.tracks.slice(0, 10).map((t, i) => `<li>${i + 1}. ${t}</li>`).join('')}
                                                            ${state.artist.tracks.length > 10 ? `<li class="text-gray-500">...and ${state.artist.tracks.length - 10} more</li>` : ''}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <button 
                                                onclick="copyMetadata()"
                                                class="w-full mt-4 bg-gray-700 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-800 transition text-sm"
                                            >
                                                üìã Copy All Metadata
                                            </button>
                                        </div>
                                        
                                        <div class="mt-3 text-sm text-gray-600 bg-white p-3 rounded border">
                                            <strong>Why this matters:</strong> You'll need this info for every registration, distributor, and royalty claim. Keep it safe and up to date.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white">
                            <h3 class="text-xl font-bold mb-2">üöÄ Coming Soon: Full Automation</h3>
                            <p class="mb-4 text-blue-100">We're building a system that will handle all registrations, forms, and follow-ups automatically. You'll just upload your credits once and we'll do the rest.</p>
                            <div class="flex gap-3">
                                <button 
                                    onclick="alert('Beta waitlist opening soon! Check back in a few days or follow us on social media.')"
                                    class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition"
                                >
                                    Join Beta Waitlist
                                </button>
                                <button 
                                    onclick="alert('Share this: rights.bewatermyfriend.be')"
                                    class="border-2 border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                                >
                                    Share with Friends
                                </button>
                            </div>
                        </div>
                    </div>

                    <button onclick="state.step = 'upload'; state.artist = {name:'',email:'',ownsMasters:null,isComposer:null,releaseYears:'',tracks:[]}; render();" class="text-gray-600 hover:text-gray-900 font-medium">
                        ‚Üê Start Over
                    </button>
                </div>
            `;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.add('border-blue-500', 'bg-blue-50');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.remove('border-blue-500', 'bg-blue-50');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropzone').classList.remove('border-blue-500', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handlePaste() {
            const text = document.getElementById('pasteArea').value;
            if (text.trim()) {
                processText(text);
            }
        }

        async function processManualInput() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) {
                alert('Please paste your credits or upload a file first');
                return;
            }
            
            state.step = 'processing';
            render();
            
            try {
                // Call API for pasted text
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileData: text,
                        fileType: 'text',
                        fileName: 'pasted-text.txt'
                    })
                });

                const result = await response.json();

                if (result.success && result.metadata) {
                    state.artist.name = result.metadata.artistName || '';
                    state.artist.email = result.metadata.email || '';
                    state.artist.releaseYears = result.metadata.releaseYears || '';
                    state.artist.ownsMasters = result.metadata.ownsMasters;
                    state.artist.isComposer = result.metadata.isComposer;
                    state.artist.tracks = result.metadata.tracks || [];
                    state.uploadedText = result.metadata.notes || '';
                } else {
                    processTextFallback(text);
                }

                state.step = 'review';
                render();
            } catch (error) {
                console.error('API error:', error);
                processTextFallback(text);
                state.step = 'review';
                render();
            }
        }

        async function processFile(file) {
            state.step = 'processing';
            render();

            try {
                let fileData;
                let fileType;

                // Determine file type and convert to base64
                if (file.type.startsWith('image/')) {
                    fileData = await fileToBase64(file);
                    fileType = 'image';
                } else if (file.type === 'application/pdf') {
                    fileData = await fileToBase64(file);
                    fileType = 'pdf';
                } else {
                    fileData = await file.text();
                    fileType = 'text';
                }

                // Call API for extraction
                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileData: fileType === 'text' ? fileData : fileData.split(',')[1],
                        fileType: fileType,
                        fileName: file.name
                    })
                });

                const result = await response.json();

                if (result.success && result.metadata) {
                    const meta = result.metadata;
                    
                    // Basic artist info
                    state.artist.name = meta.artist?.name || '';
                    state.artist.email = meta.artist?.email || '';
                    
                    // Handle releases (take first one for now, or combine)
                    if (meta.releases && meta.releases.length > 0) {
                        const firstRelease = meta.releases[0];
                        state.artist.releaseYears = firstRelease.year || '';
                        state.artist.tracks = firstRelease.tracks || [];
                    }
                    
                    // Handle rights with conflicts
                    if (meta.rights) {
                        if (meta.rights.masterOwnership === 'OWNS') {
                            state.artist.ownsMasters = true;
                        } else if (meta.rights.masterOwnership === 'DOES_NOT_OWN') {
                            state.artist.ownsMasters = false;
                        } else {
                            state.artist.ownsMasters = null; // Unknown or conflicted
                        }
                        
                        if (meta.rights.composition === 'SOLE') {
                            state.artist.isComposer = true;
                        } else if (meta.rights.composition === 'CO_WRITTEN') {
                            state.artist.isComposer = false;
                        } else {
                            state.artist.isComposer = null; // Unknown or conflicted
                        }
                    }
                    
                    // Store conflicts and clarifications for review page
                    state.conflicts = {
                        masterNotes: meta.rights?.masterOwnershipNotes || '',
                        compositionNotes: meta.rights?.compositionNotes || '',
                        clarifications: meta.clarificationNeeded || [],
                        errors: meta.parsingErrors || []
                    };
                } else {
                    // Fallback to regex extraction
                    processTextFallback(fileType === 'text' ? fileData : '');
                    state.conflicts = null;
                }

                state.step = 'review';
                render();
            } catch (error) {
                console.error('Extraction error:', error);
                alert('Extraction failed. Please fill in the form manually.');
                state.step = 'review';
                render();
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function processTextFallback(text) {
            state.uploadedText = text;
            
            const lines = text.split('\n');
            
            const artistMatch = text.match(/(?:artist|by|name)[\s:]+([^\n,]+)/i);
            if (artistMatch) state.artist.name = artistMatch[1].trim();
            
            const emailMatch = text.match(/[\w.-]+@[\w.-]+\.\w+/);
            if (emailMatch) state.artist.email = emailMatch[0];
            
            const yearMatch = text.match(/(20\d{2}(?:\s*[-‚Äì]\s*20\d{2})?)/);
            if (yearMatch) state.artist.releaseYears = yearMatch[1];
            
            if (/(?:own|produced by|master)/i.test(text)) {
                state.artist.ownsMasters = true;
            }
            if (/(?:written by|composed by|lyrics|composer)/i.test(text)) {
                state.artist.isComposer = true;
            }
            
            state.artist.tracks = lines
                .filter(line => /^(?:\d+[\.\):]|\-|‚Ä¢|track)/i.test(line.trim()))
                .map(line => line.replace(/^(?:\d+[\.\):]|\-|‚Ä¢|track)\s*/i, '').trim())
                .filter(t => t.length > 0 && t.length < 100);
        }

        function processText(text) {
            // This is now the fallback - renamed to processTextFallback and called from processFile
            processTextFallback(text);
            state.step = 'review';
            render();
        }

        function updateField(field, value) {
            state.artist[field] = value;
            render();
        }

        function finalize() {
            // Values are already in state from oninput handlers
            if (!state.artist.name || !state.artist.email) {
                alert('Please fill in your name and email');
                return;
            }
            
            state.step = 'dashboard';
            render();
        }

        function copySabamEmail() {
            const email = `Subject: SABAM Writer & Publisher Registration Request

Dear SABAM,

I am an independent musician based in Belgium and would like to register as both a writer and publisher.

Artist Name: ${state.artist.name}
Email: ${state.artist.email}
Role: Composer, Lyricist, Producer, Performer

I own 100% of my master recordings and compositions for upcoming releases.

Could you please send me the registration forms and next steps?

Thank you,
${state.artist.name}`;

            navigator.clipboard.writeText(email);
            alert('‚úì Email copied! Paste it into your email client and send to info@sabam.be');
        }

        function copyPlayRightEmail() {
            const email = `Subject: PlayRight Performer Registration

Dear PlayRight,

I am a performing artist and would like to register for neighboring rights collection.

Artist Name: ${state.artist.name}
Email: ${state.artist.email}

I perform on my own recordings as the primary artist and own the masters.

Please send me the registration information.

Best regards,
${state.artist.name}`;

            navigator.clipboard.writeText(email);
            alert('‚úì Email copied! Paste it into your email client and send to info@playright.be');
        }

        function copyMetadata() {
            const tracks = state.artist.tracks.length > 0 
                ? `\n\nTracks (${state.artist.tracks.length}):\n${state.artist.tracks.map((t, i) => `${i + 1}. ${t}`).join('\n')}`
                : '';
            
            const ownership = `\n\nOwnership:\n${state.artist.ownsMasters === true ? '‚úì Masters: You own them' : state.artist.ownsMasters === false ? '‚úó Masters: Label owns' : 'Masters: Not specified'}\n${state.artist.isComposer === true ? '‚úì Composition: You wrote it' : state.artist.isComposer === false ? '‚úó Composition: Co-written' : 'Composition: Not specified'}`;
            
            const metadata = `MUSIC METADATA RECORD
Generated: ${new Date().toLocaleDateString()}

Artist: ${state.artist.name}
Email: ${state.artist.email}
Release Year: ${state.artist.releaseYears || 'Not specified'}${ownership}${tracks}

---
Keep this record updated for all registrations and distributions.`;

            navigator.clipboard.writeText(metadata);
            alert('‚úì Metadata copied to clipboard! Paste it into a text file or document to save.');
        }

        render();
    </script>
</body>
</html>
